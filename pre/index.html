<!DOCTYPE html>
<html>
	<head>
		<title>Medium Augustus FCM web push demo code - Augustus - Let's Write</title>
		<link rel="canonical" href="https://letswrite.tw/pwa-web-push/">
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">

		<link rel="shortcut icon" href="https://i0.wp.com/letswrite.tw/wp-content/uploads/2019/07/cropped-letswrite512-1.jpg" />
		<link rel="manifest" href="manifest.json">

		<!-- Google Tag Manager-->
		<script>
			(function(w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({
					'gtm.start': new Date().getTime(),
					event: 'gtm.js'
				});
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src =
					'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, 'script', 'dataLayer', 'GTM-PGQ9WQT');
		</script>

	</head>
	<body>
		<!-- Google Tag Manager (noscript)-->
		<noscript>
			<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PGQ9WQT" height="0" width="0" style="display:none;visibility:hidden"></iframe>
		</noscript>


		<!-- The core Firebase JS SDK is always required and must be listed first -->
		<script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-app.js"></script>

		<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
		<script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-messaging.js"></script>

		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyBBnECtCvqhG3wmZpORfS3VJZlgjK1KLaU",
				authDomain: "test-6d390.firebaseapp.com",
				databaseURL: "https://test-6d390.firebaseio.com",
				projectId: "test-6d390",
				storageBucket: "test-6d390.appspot.com",
				messagingSenderId: "1072871991195"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			var database = firebase.database();
			var messaging = firebase.messaging();
			messaging.usePublicVapidKey(
				'BOcVtHmZ6xJMkhgKmtgmsGcr8zZVOfQJEfiynuGlVGqAwFFERoFFoFZFAnI7j3o5fFHhnahnOVdAJifO_EnBFaQ');

			// 頁面是開啟的狀態下，改用 firebase onMessage()
			messaging.onMessage(function(payload) {
				console.log(payload);
				console.log(123456);
				var msgTitle = payload.data.title;
				var url = payload.data.click_action;
				var notification = new Notification(msgTitle, payload.data);

				// 點擊推播後要連去哪
				notification.addEventListener('click', function() {
					e.preventDefault();
					location.href = url;
				});
			});

			window.addEventListener('load', function() {
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('sw.js')
						.then(function(reg) {
							// firebase methods，用同一支sw.js
							messaging.useServiceWorker(reg);
							messaging.requestPermission().then(function() {
								// 先判斷cookies有沒有token，沒有再取token
								var ckv = document.cookie.replace(/(?:(?:^|.*;\\s*)augustusWsPush\s*\=\s*([^;]*).*$)|^.*$/, "$1") || null;

								// cookies不存在，跟使用者要求通知權限
								if (ckv === null) {
									// 拿到token，firebase-messaging-sw.js 就會存 Service Workers 裡
									messaging.getToken().then(function(currentToken) {
										// token存至firebase
										var id = currentToken.split(':')[0];
										firebase.database().ref('pushUsers/' + id).set({
											'token': currentToken
										});

										// token存至cookies
										document.cookie = "augustusWsPush=" + currentToken;

									});
								}
								// cookies 已存在，從 cookies 取出後傳至 firebase
								else {
									var id = ckv.split(':')[0];
									firebase.database().ref('pushUsers/' + id).set({
										'token': ckv
									});
								}
							}).catch(function(err) {
								console.log('使用者未允許通知', err);
							});

						})
						// 註冊失敗
						.catch(function(err) {
							console.log('error: ', err);
						});
				}

			});
		</script>

	</body>
</html>
